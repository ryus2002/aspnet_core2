# 微服務電商平台系統交互流程圖

## 1. 系統交互概述

本文檔描述了微服務電商平台中各服務之間的交互流程。這些流程圖展示了系統在處理各種業務場景時，不同服務之間如何協同工作。

## 2. 用戶註冊與登入流程

```
┌─────────┐      ┌─────────────┐      ┌─────────────┐
│  客戶端  │─────▶│  API Gateway │─────▶│  認證服務   │
└─────────┘      └─────────────┘      └─────────────┘
                                            │
                                            ▼
                                      ┌─────────────┐
                                      │ 用戶數據庫   │
                                      └─────────────┘
```

1. 客戶端發送註冊/登入請求到 API Gateway
2. API Gateway 將請求轉發到認證服務
3. 認證服務處理請求並與用戶數據庫交互
4. 認證服務返回 JWT Token 或錯誤信息
5. API Gateway 將結果返回給客戶端

## 3. 商品瀏覽與搜尋流程

```
┌─────────┐      ┌─────────────┐      ┌─────────────┐
│  客戶端  │─────▶│  API Gateway │─────▶│  商品服務   │
└─────────┘      └─────────────┘      └─────────────┘
                                            │
                                            ▼
                                      ┌─────────────┐
                                      │ 商品數據庫   │
                                      └─────────────┘
```

1. 客戶端發送商品查詢請求到 API Gateway
2. API Gateway 將請求轉發到商品服務
3. 商品服務查詢商品數據庫
4. 商品服務返回商品列表或詳情
5. API Gateway 將結果返回給客戶端

## 4. 訂單創建流程

```
┌─────────┐      ┌─────────────┐      ┌─────────────┐
│  客戶端  │─────▶│  API Gateway │─────▶│  訂單服務   │
└─────────┘      └─────────────┘      └─────────────┘
                                            │
                                            ▼
                                      ┌─────────────┐
                                      │ 訂單數據庫   │
                                      └─────────────┘
                                            │
                                            ▼
                                      ┌─────────────┐     ┌─────────────┐
                                      │  RabbitMQ   │────▶│  商品服務   │
                                      └─────────────┘     └─────────────┘
                                            │                   │
                                            │                   ▼
                                            │             ┌─────────────┐
                                            │             │ 商品數據庫   │
                                            │             └─────────────┘
                                            ▼
                                      ┌─────────────┐
                                      │  支付服務   │
                                      └─────────────┘
                                            │
                                            ▼
                                      ┌─────────────┐
                                      │ 支付數據庫   │
                                      └─────────────┘
```

1. 客戶端發送訂單創建請求到 API Gateway
2. API Gateway 將請求轉發到訂單服務
3. 訂單服務創建訂單並存儲到訂單數據庫
4. 訂單服務通過 RabbitMQ 發送訂單創建事件
5. 商品服務接收事件並更新商品庫存
6. 支付服務接收事件並創建支付記錄
7. 訂單服務返回訂單創建結果
8. API Gateway 將結果返回給客戶端

## 5. 支付處理流程

```
┌─────────┐      ┌─────────────┐      ┌─────────────┐
│  客戶端  │─────▶│  API Gateway │─────▶│  支付服務   │
└─────────┘      └─────────────┘      └─────────────┘
                                            │
                                            ▼
                                      ┌─────────────┐
                                      │ 支付數據庫   │
                                      └─────────────┘
                                            │
                                            ▼
                                      ┌─────────────┐     ┌─────────────┐
                                      │  RabbitMQ   │────▶│  訂單服務   │
                                      └─────────────┘     └─────────────┘
                                                                │
                                                                ▼
                                                          ┌─────────────┐
                                                          │ 訂單數據庫   │
                                                          └─────────────┘
```

1. 客戶端發送支付請求到 API Gateway
2. API Gateway 將請求轉發到支付服務
3. 支付服務處理支付並更新支付數據庫
4. 支付服務通過 RabbitMQ 發送支付完成事件
5. 訂單服務接收事件並更新訂單狀態
6. 支付服務返回支付結果
7. API Gateway 將結果返回給客戶端

## 6. 數據一致性保證

為確保分佈式系統中的數據一致性，系統採用以下策略：

1. **最終一致性**：通過事件驅動架構，確保數據最終達到一致狀態
2. **補償事務**：當操作失敗時，執行補償操作恢復系統狀態
3. **重試機制**：對於失敗的消息處理，實施自動重試策略
4. **死信隊列**：處理無法成功處理的消息，以便後續人工介入