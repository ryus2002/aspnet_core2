# ADR-0004: 認證機制決策

## 狀態

已接受

## 背景

在微服務電商平台中，需要一個安全且有效的用戶認證機制，以確保系統安全並提供良好的用戶體驗。認證機制需要在分布式系統環境中工作，支持跨服務的身份驗證，同時適合本地開發環境。我們需要決定最適合我們系統架構的認證方案。

## 決策

我們決定採用 JWT (JSON Web Token) 作為主要的認證機制，並使用 bcrypt 進行密碼哈希處理。認證流程將由獨立的認證服務負責管理，其他服務通過驗證 JWT 來確認用戶身份和權限。

## 考量因素

- 分布式系統中的認證需求
- 無狀態設計的可行性
- 安全性要求
- 用戶體驗（登入流程、會話管理）
- 跨服務認證的便利性
- 開發和調試的便利性
- 擴展性和未來需求
- 本地開發環境的適用性

## 方案

### 方案1: JWT 認證（已選擇）

使用 JWT 作為身份驗證令牌，由認證服務簽發，其他服務驗證。

**優點:**
- 無狀態，不需要在服務器端存儲會話信息
- 適合分布式系統，各服務可獨立驗證令牌
- 包含用戶信息和權限，減少數據庫查詢
- 可設置過期時間，提高安全性
- 廣泛的庫支持，易於實現
- 適合微服務架構

**缺點:**
- 令牌一旦簽發無法撤銷（除非使用黑名單）
- 令牌大小可能較大，增加請求負載
- 需要妥善保護簽名密鑰
- 令牌中的信息可被解碼（雖然不能被篡改）

### 方案2: Session 認證

使用傳統的基於 Session 的認證，會話信息存儲在服務器端。

**優點:**
- 易於實現和理解
- 可以隨時撤銷會話
- 會話數據存儲在服務器，客戶端只需存儲 ID
- 成熟的解決方案，有豐富的文檔

**缺點:**
- 需要共享會話存儲，增加系統複雜性
- 不適合無狀態設計
- 擴展性較差，需要會話黏性或中央存儲
- 在微服務架構中實現較為複雜

### 方案3: OAuth 2.0 / OpenID Connect

實現完整的 OAuth 2.0 / OpenID Connect 協議。

**優點:**
- 支持第三方認證（社交登入）
- 標準化的協議
- 支持不同的授權流程
- 更完善的安全特性

**缺點:**
- 實現複雜度高
- 對於簡單的系統可能過於重量級
- 本地開發環境配置較為複雜
- 需要更多的基礎設施支持

## 影響

- **技術影響**: 需要實現 JWT 生成、驗證和刷新機制
- **資源影響**: JWT 驗證可在各服務本地進行，減少跨服務調用
- **風險**: JWT 密鑰管理、令牌過期策略需要謹慎設計
- **依賴關係**: 所有服務依賴於認證服務簽發的 JWT

## 實施計劃

1. 在認證服務中實現用戶註冊和認證邏輯
2. 實現 JWT 簽發機制，包括用戶信息和權限
3. 在 API Gateway 中實現 JWT 驗證中間件
4. 為各微服務提供 JWT 驗證工具
5. 實現令牌刷新機制
6. 建立安全的密碼存儲（使用 bcrypt）

## 評估指標

- 認證流程的響應時間
- 安全性評估（防止常見攻擊）
- 用戶體驗流暢度
- 跨服務認證的可靠性
- 系統擴展時的認證效能

## 相關決策

- [ADR-0001](0001-microservices-decomposition.md) - 微服務拆分決策
- [ADR-0003](0003-service-communication-mechanism.md) - 服務通訊機制決策