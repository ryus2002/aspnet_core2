# ADR-0003: 服務通訊機制決策

## 狀態

已接受

## 背景

在微服務架構中，服務間的通訊機制是系統設計的關鍵部分。我們需要決定微服務電商平台中各服務之間如何進行有效通訊，以確保系統的可靠性、效能和可維護性。這個決策需要考慮同步和異步通訊的場景，以及本地開發環境的限制。

## 決策

我們決定採用混合通訊策略，結合 RESTful API（同步通訊）和 RabbitMQ（異步通訊）作為服務間的主要通訊機制：

1. **RESTful API**：用於需要立即響應的同步通訊場景
2. **RabbitMQ**：用於事件驅動的異步通訊場景，特別是跨服務的業務流程

## 考量因素

- 通訊模式的適用性（同步 vs 異步）
- 本地開發環境的易用性
- 系統的可靠性和容錯能力
- 開發團隊的技術熟悉度
- 消息傳遞的保證（至少一次、最多一次、恰好一次）
- 系統的擴展性
- 開發和維護的複雜度

## 方案

### 方案1: 混合通訊策略（已選擇）

結合 RESTful API 和 RabbitMQ 分別處理同步和異步通訊需求。

**優點:**
- 針對不同通訊需求選擇最適合的機制
- RESTful API 簡單直觀，適合請求-響應模式
- RabbitMQ 提供可靠的消息傳遞，支持發布-訂閱模式
- 解耦服務，提高系統彈性
- 通過異步處理提高系統吞吐量

**缺點:**
- 需要管理兩種不同的通訊機制
- 增加系統複雜性
- 需要處理消息重複和順序問題
- 需要額外的基礎設施（消息隊列）

### 方案2: 純 RESTful API

所有服務間通訊都通過 RESTful API 實現。

**優點:**
- 架構簡單，易於理解
- 無需額外的消息中間件
- HTTP 協議廣泛支持
- 開發團隊通常更熟悉

**缺點:**
- 同步通訊可能導致服務間強耦合
- 系統可靠性降低（一個服務故障可能影響整個調用鏈）
- 難以處理需要最終一致性的場景
- 系統吞吐量受限於最慢的服務

### 方案3: 純事件驅動架構

所有服務間通訊都通過事件和消息隊列實現。

**優點:**
- 服務完全解耦
- 高度可擴展性
- 良好的容錯能力
- 適合複雜的業務流程

**缺點:**
- 系統複雜度大幅增加
- 難以追蹤和調試跨服務流程
- 需要處理事件版本和兼容性問題
- 不適合需要即時響應的場景

## 影響

- **技術影響**: 需要實現 RESTful API 客戶端和 RabbitMQ 消息處理機制
- **資源影響**: 本地開發環境需要運行 RabbitMQ 服務，增加資源消耗
- **風險**: 消息處理失敗、消息重複、順序問題需要額外處理機制
- **依賴關係**: 服務間通訊依賴於 API Gateway 和 RabbitMQ 的可用性

## 實施計劃

1. 首先實現基本的 RESTful API 通訊機制
2. 設置本地 RabbitMQ 服務和基本配置
3. 定義關鍵業務事件和消息格式
4. 實現訂單創建、庫存更新等核心事件流
5. 建立消息處理的錯誤處理和重試機制

## 評估指標

- 系統響應時間
- 消息處理的可靠性（成功率）
- 系統吞吐量
- 服務間的解耦程度
- 開發和維護的複雜度
- 故障恢復能力

## 相關決策

- [ADR-0001](0001-microservices-decomposition.md) - 微服務拆分決策